#!/usr/bin/env python

"""
This script checks Probely for outstanding "high" vulnerabilities and posts
a message to Slack if any are found
"""

import os
from collections import defaultdict
from urllib.parse import urljoin
import requests
from slack_sdk.webhook import WebhookClient

def api_headers(api_token):
  """Get the appropriate API headers for Probely"""
  return {
      "Authorization": f"JWT {api_token}",
      "Content-Type": "application/json"
      }
      
def main():
  probely_api_token = os.getenv("PROBELY_API_TOKEN") or exit("PROBELY_API_TOKEN environment variable is required")
  slack_webhook = os.getenv("SLACK_WEBHOOK_URL") or exit("SLACK_WEBHOOK_URL environment variable is required")

  # Check for new high vulnerabilities 
  # Target event: High identified vulnerability (finding_detected: 30 (high))
  API_BASE_URL = "https://api.probely.com"
  account_findings_endpoint = urljoin(
      API_BASE_URL, "findings/?severity=30&state=notfixed&length=100"
  )

  response = requests.get(account_findings_endpoint,
                          headers=api_headers(probely_api_token),
                          timeout=30)

  response_json = response.json()
  vulnerability_count = response_json['count']

  if vulnerability_count > 0:
    print(f"{vulnerability_count} high vulnerabilities found")

    findings_grouped_by_target = defaultdict(list)
    for finding in response.json()["results"]: 
      findings_grouped_by_target[finding["target"]["site"]["name"]].append(finding)

    slack_message_blocks = [{
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": f"ðŸ“£ðŸ“£ðŸ“£ There are *{vulnerability_count}* HIGH vulnerabilities in Probely ðŸ“£ðŸ“£ðŸ“£"
                }
            }]

    for target_name, findings in findings_grouped_by_target.items():

      target_url = findings[0]["target"]["site"]["url"]
      target_id = findings[0]["target"]["id"]
      probely_target_url = f"https://plus.probely.app/targets/{target_id}"

      slack_message_blocks.append({
                  "type": "header",
                  "text": {
                      "type": "plain_text",
                      "text": f"{target_name}"
                  }
              })

      # Uncomment to include an additional link to the Probely target
      # slack_message_blocks.append({
      #             "type": "context",
      #             "elements": [{
      #                 "type": "mrkdwn",
      #                 "text": f"{target_url} (<{probely_target_url}|Probely target>)"
      #             }]
      #         })

      for finding in findings:
        finding_id = finding["id"]
        target_id = finding["target"]["id"]

        # Finding URL e.g. https://plus.probely.app/targets/AjGpGmFrVRKk/findings/9
        probely_url = f"https://plus.probely.app/targets/{target_id}/findings/{finding_id}"

        slack_message_blocks.append({
                  "type": "section",
                  "text": {
                      "type": "mrkdwn",
                      "text": f"ðŸš¨ <{probely_url}|{finding['definition']['name']}>"
                  }
              })


    # Post the alert to slack
    webhook = WebhookClient(os.getenv('SLACK_WEBHOOK_URL'))
    response = webhook.send(
        text="fallback",
        blocks= slack_message_blocks
    )
  else:
    print("No high vulnerabilities found, well done ðŸŽ‰")


if __name__ == '__main__':
    main()